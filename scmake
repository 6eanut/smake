#!/usr/bin/python

# Assume compilation db exists under the current directory,
# generated by using CMAKE_EXPORT_COMPILE_COMMANDS=1

import json
import os
import subprocess

with open("./compile_commands.json") as f:
  compilation_db = json.load(f)

def replace(file, cmd):
    new_cmd = []
    for tok in cmd.split(' '):
        if tok == "-c":
            new_cmd.append("-E")
        elif tok.endswith('.c'):
            new_cmd.append(file) # absolute path
        elif tok.endswith('.o'):
            new_cmd.append(file + ".i")
        else:
            new_cmd.append(tok)
    return new_cmd

for entry in compilation_db:
    os.chdir(entry['directory'])
    cmd = replace(entry['file'], entry['command'])
    print(entry['file'])
    subprocess.check_output(cmd)
